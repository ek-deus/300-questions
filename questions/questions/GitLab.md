## Ошибка 502 в GitLab

Нередко пользователи сервиса GitLab сталкиваются с проблемой под названием «Ошибка 502». Как правило, она сопровождается следующей фразой: «Whoops, GitLab is taking too much time to respond». Давайте разберём, в чём может быть проблема. 

Ошибку 502, как и вышеупомянутую фразу, вам показывает Nginx (компонент, входящий в GitLab). В общем случае речь идёт о том, что web-сервер не может получить от бэкенда ответ. А раз мы говорим о GitLab, то бэкендом здесь выступает Unix-сокет — /var/opt/gitlab/gitlab-workhorse/socket. Тут стоит упомянуть, что конфигурация Nginx для GitLab находится по адресу /var/opt/gitlab, а конкретно Nginx — здесь: /var/opt/gitlab/nginx/conf.

# Почему же бэкенд не отвечает?
Ответить на этот вопрос со 100%-ной точностью нельзя. Но ряд причин всё же имеется:
1. У вас на сервере недостаточно оперативной памяти. Если памяти всего 2 Гб, ошибку 502 вы будете всё равно время от времени видеть, даже работая с GitLab в одиночку. Дело в том, что для работы таких компонентов, как Nginx, PostgreSQL, Redis и прочих требуется много памяти. В качестве решения проблемы можно увеличить либо включить swap.
2. У вас упала служба под названием GitLab-workhorse. Она открывает сокет, который слушает Nginx. А вот почему это произошло — вопрос отдельный. Не менее интересно и то, почему она функционирует, а сокета нет. Чтобы решить проблему, попробуйте просто перезагрузить сервер. Также бывает, что сервис падает из-за занятого порта какой-то службы, относящейся к GitLab. Это случается, если на сервере, кроме GitLab запущены другие службы. Ошибки могут быть и в конфигурации. Также нередко проблемы появляются после обновления.
3. Из-за каких-то причин изменились права доступа к сокету /var/opt/gitlab/gitlab-workhorse/socket, в результате чего Nginx не может получить доступ. Проверьте, от какого именно пользователя работает Nginx и удостоверьтесь, что у него достаточно прав для доступа к сокету.

Пожалуй, это основные причины возникновения ошибки 502 в GitLab, покрывающие большинство случаев.

Более подробно ознакомиться с архитектурой GitLab и освоить нюансы его работы вы можете на курсе CI/CD. Именно этой теме посвящено несколько занятий из первого модуля. Скачать программу курса можно здесь. 

## Диагностика:

Для начала выполним команду
```
free -h

gitlab-ctl status
```
вывод должен быть  примерно таким

```
root@gitlab:~# gitlab-ctl status
run: alertmanager: (pid 1728) 234s; run: log: (pid 1709) 234s
run: gitaly: (pid 1739) 233s; run: log: (pid 1718) 234s
run: gitlab-exporter: (pid 1723) 234s; run: log: (pid 1708) 234s
run: gitlab-kas: (pid 1734) 233s; run: log: (pid 1713) 234s
run: gitlab-workhorse: (pid 1741) 233s; run: log: (pid 1716) 234s
run: grafana: (pid 1721) 234s; run: log: (pid 1705) 234s
run: logrotate: (pid 1722) 234s; run: log: (pid 1706) 234s
run: nginx: (pid 1735) 233s; run: log: (pid 1715) 234s
run: node-exporter: (pid 1736) 233s; run: log: (pid 1714) 234s
run: postgres-exporter: (pid 1707) 234s; run: log: (pid 1701) 234s
run: postgresql: (pid 1733) 233s; run: log: (pid 1712) 234s
run: prometheus: (pid 1725) 234s; run: log: (pid 1711) 234s
run: puma: (pid 1737) 233s; run: log: (pid 1717) 234s
run: redis: (pid 1702) 234s; run: log: (pid 1700) 234s
run: redis-exporter: (pid 1724) 234s; run: log: (pid 1710) 234s
run: sidekiq: (pid 1740) 233s; run: log: (pid 1719) 234s
```

